---
title: 筛法和数论分块
titleTemplate: 数学
---

### 筛法

我们直到判断一个数是不是质数，只要判断到根号级别，因为如果一个数能表示成两个数字相乘，其中必然有一个数字小于等于$\sqrt{n}$。

否则如果两个都大于根号，那么乘起来就大于这个数了。

而筛法是至，用一个大一点的时间复杂度，来判断出$1\sim n$里面所有数字的性质。

比如素数筛一般是用来判断$1\sim n$里面每个数字是不是质数的。

这种筛法可能是$O(nlogn)$的，但是均摊到每个数字上只有$O(logn)$，和单个数字判断适用于不同的场景。

小常识：$1\sim n$以内，质因子的个数是$O(\frac{n}{logn})$数量级的。

### 埃拉托尼斯筛

从$2$开始，将每个数字的倍数都标记为非素数，没有被小数字标记过的数字就是素数。

```cpp
for(int i=2;i<=n;++i)
{
	if(!vis[i]) prime[++num]=i;
	for(int j=2*i;j<=n;j+=i)
		vis[j]=1;
}
```

根据调和级数，我们知道这个复杂度是$O(nlogn)$

然而，如果一个数本身不是质数，那么它一定是一个质数的若干倍，它的倍数已经被自己的质因子标记过了，所以它可以跳过。

```cpp
for(int i=2;i<=n;++i)
{
    if(vis[i]) continue;
	prime[++num]=i;
	for(int j=2*i;j<=n;j+=i)
		vis[j]=1;
}
```

这样的复杂度是$O(nlog(logn))$的。

感兴趣复杂度可以自己证明一下。

但是这样还是有重复，比如$15$要被$3$和$5$筛两次。

我们希望每个数字只被筛一次。比如被最小的质因子筛掉。

但是在这个枚举方式下是不可能的。

因为比如我枚举的是$3$，那$3*2$不应该我筛，$3*3$应该我筛，$3*4$不应该我筛，$3*5$又应该我筛了，这样很复杂。

换一个思路，我们去枚举倍数去，也就是去枚举上面代码中的$j/i$。

先枚举倍数，再枚举质因子是多少。

这样，比如我们枚举倍数$2$，然后枚举质因子，$2,3$，发现$2*3=6$的最小质因子是$2$，但是我们用$3$筛了，所以结束。

枚举倍数$3$，枚举质因子$2,3,5$，发现$3*5=15$的最小质因子是$3$，但是我们用$5$筛了，所以结束。

枚举倍数$4$，枚举质因子$2,3$，发现不能去筛$3*4$，因为$3*4=12$，最小质因子是$2$，但是被$3$筛了，所以结束。

总结一下，就是如果枚举的倍数$i$和枚举的质数$j$的乘积，它的最小质因子不是$j$，那么就应该终止。

但是我们并不知道一个数的最小质因子是多少（废话，知道了就不用筛了）。

别急，我们看一下终止前的一个数字。

$2:2$

$3:3$

$4:2$

所以总结出了，只要倍数$i$是质数$j$的倍数，那么标记完$i*j$就应该终止！

因为说明倍数$i$里面含有质因子$j$，那么下一个质因子，它和$i$相乘，一定不会作为乘积的最小质因子。

```cpp
for(int i=2;i<=n;++i)
{
	if(!vis[i]) prime[++num]=i;//如果没被标记过，说明是质数
    for(int j=1;j<=num&&i*prime[j]<=n;++j)//枚举质因子，上面已经存起来了
    {
        vis[i*prime[j]]=1;//标记
        if(i%prime[j]==0) break;
        //如果i是prime[j]的倍数，那么就可以结束了，后面的质数都不是最小质因子。
    }
}
```

### 除法分块

另一个问题：

给定函数$f$，求$\sum_{i=1}^nf(\lfloor \frac{n}{i}\rfloor)$的值。

其中$\lfloor x\rfloor$表示$x$下取整

普通的做法是暴力，是$O(n*f)$的，其中$f$是求解函数的复杂度。

但是因为是下取整，所以其实有挺多地方的值都是一样的。

比如，$10$，它对于$1\sim 10$除法下取整分别是：

```cpp
10 5 3 2 2 1 1 1 1 1
```

有很多点的值是重复的，没必要重复算。

所以我们可以利用这一点来优化，对于相同的商，一起来算答案。

```cpp
for(int l=1,r,k,r<=n;l=r+1)
{
	k=n/l;//当前的商是多少
    r=n/k;//在商为k的前提下，除数最小是l,最大是r
    ans+=f(k)*(r-l+1);//有这么多个点值相同
}
```

这样复杂度是$O(\sqrt{n})$

这样来算。

如果除数小于$\sqrt{n}$，那么这部分也就贡献$O(\sqrt{n})$个。

如果除法大于$\sqrt{n}$，那么被除数就小于$\sqrt{n}$，所以最多有$\sqrt{n}$种不同的情况，也就贡献$O(\sqrt{n})$。

总复杂度是$O(\sqrt{n})$的。

### 例题

求$\sum_{i=1}^n k\ mod\ i$

等价于$\sum_{i=1}^n k-\lfloor\frac{k}{i}\rfloor*i$

等价于$n*k-\sum_{i=1}^n\lfloor\frac{k}{i}\rfloor*i$

然后愉快地除法分块。

### 练习题

[P3383 【模板】线性筛素数  ](https://www.luogu.com.cn/problem/P3383)

[P1865 A % B Problem  ](	https://www.luogu.com.cn/problem/P1865)

[P2261 [CQOI2007] 余数求和  ](https://www.luogu.com.cn/problem/P2261)

[P2260 [清华集训2012] 模积和  ](https://www.luogu.com.cn/problem/P2260)

