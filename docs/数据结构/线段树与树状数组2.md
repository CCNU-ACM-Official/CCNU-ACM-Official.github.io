---
title: 线段树与树状数组2
titleTemplate: 数据结构
---

###  	线段树标记合并

[线段树2](https://www.luogu.com.cn/problem/P3373)

省流：区间加$x$，区间乘$x$，求区间和。

设置三个数组：

$ans[p]$，节点$p$的和

$add[p]$，节点$p$的所有子树应该加上的数，初始为$0$。

$mul[p]$，节点$p$的所有子树应该乘以的数，初始为$1$。

所以我们同时有两个标记，该怎么编排这两个标记的顺序？

如果我们认为，一个节点应该是$(ans[p]+add[p])*mul[p]$，那么在更新一个节点的时候：

进行区间加法时，应该$ans[p]+=(r-l+1)*\frac{mul[p]}{x},add[p]+=\frac{mul[p]}{x}$

进行区间乘法时，应该$ans[p]*=x,mul[p]*=x$

这样就有分数了，不好。

所以最好是认为$(ans[p]*mul[p])+add[p]$（也就是两个标记同时存在时，先下放乘法，再下放加法）。

进行区间加法时，应该$ans[p]+=(r-l+1)*x,add[p]+=x$。

进行区间乘法时，应该$ans[p]*=x,add[p]*=x,mul[p]*=x$。

这样就没有分数，避免误差。

### 势能线段树

[上帝造题的七分钟 2 / 花神游历各国  ](https://www.luogu.com.cn/problem/P4145)

省流：区间求和，区间开平方。

数值$\leq 10^{12}$。

要注意到$10^{12}$最多开$6$次根号就会变成$1$，然后再怎么开根号也都是$1$了。

所以如果一个位置是$1$就跳过它，否则就暴力地给这个位置开根号。

怎么跳过呢，在线段树上设置节点信息$ans[p]$，等于$1$的时候表示这个节点所表示的区间里面全都是$1$，否则这个节点所表示的区间里面还有不是$1$的数字。

如果全都是$1$，直接$return$。

否则递归进去，找到不是$1$的所有位置，暴力开根号。

### 线段树上二分

线段树天然是二分结构

例如，有一个数组$a_i$，每个位置上有$0/1$，每次翻转一段区间的状态，然后去找一段区间里面最左边的$0$的位置。

设线段树维护每一段区间的和是多少。

修改就不多说了，标准套路

查询如下：

```cpp
int query(int tl,int tr,int l,int r,int p)
{
	if(l==r)//找到了位置
    {
        if(a[l]==0) return l;
        return 0;
    }
    if(tag[p]) pushdown(p);//下放标记
    if(tl<=l&&r<=tr)//如果包含在查询区间里
    {
        if(ans[ls(p)]==mid-l+1) return query(tl,tr,mid+1,r,rs(p));//如果左区间是满的，去右边找
        return query(tl,tr,l,mid,ls(p));//如果左区间不满，在左边找。
    }
    int pos=0;
    if(tl<=mid) pos=query(tl,tr,l,mid,ls(p));
    if(tr>mid&&pos) pos=query(tl,tr,mid+1,r,rs(p));
    return pos;
    //这里也是先在左边找，如果左边没找到再在右边找
}
```





